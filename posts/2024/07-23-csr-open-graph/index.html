<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.13.7"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-L03MWQBJJC"></script><script>
    window.GATSBY_GTAG_PLUGIN_GA_TRACKING_ID = (
      'G-L03MWQBJJC'
    );
    window.GATSBY_GTAG_PLUGIN_ANONYMIZE = false;

    var options = {
      send_page_view: false
    };
    if (false) {
      options.anonymize_ip = true;
    }

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', 'G-L03MWQBJJC', options);
  </script><title data-gatsby-head="true">CSR에서 동적 OG 적용하기 | hanse-kim.dev</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,300,0,0" data-gatsby-head="true"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css 11pfcjj">.css-11pfcjj{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;}</style><div class="css-11pfcjj e1u3ibb77"><style data-emotion="css-global f9567y">@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500&display=swap');html{box-sizing:border-box;font-size:16px;font-weight:400;line-height:1.55;-webkit-text-size-adjust:100%;}*,:after,:before{box-sizing:inherit;}body,h1,h2,h3,h4,h5,h6,ol,ul,p,pre,blockquote{margin:0;padding:0;font-weight:inherit;}main{display:block;}ol,ul{list-style:none;}img{border-style:none;max-width:100%;height:auto;object-fit:cover;}hr{box-sizing:content-box;height:0;overflow:visible;}a{background-color:transparent;color:inherit;outline:0;}a,a:active,a:hover{-webkit-text-decoration:none;text-decoration:none;}button,input,optgroup,select,textarea{color:inherit;font-family:inherit;font-size:inherit;font-weight:inherit;line-height:inherit;margin:0;}:root{--page-width:960px;--header-height:72px;--footer-height:120px;--z-index-base:0;--z-index-overlay:1100;--z-index-modal:1200;--color-main:#0076da;--color-text:#1a1e21;--color-text-footer:#3f4950;--color-text-quote:#63727e;--color-bg:#ffffff;--color-blur:#f4f5f675;--color-bg-footer:#f4f5f6;--color-border:#e6e8ea;--color-overlay:rgba(0, 0, 0, 0.5);--font-weight-thin:100;--font-weight-light:300;--font-weight-regular:400;--font-weight-medium:500;--font-size-xs:12px;--font-size-sm:14px;--font-size-md:16px;--font-size-lg:18px;--font-size-xl:20px;--font-size-h4:18px;--font-size-h3:20px;--font-size-h2:28px;--font-size-h1:32px;--font-size-sub-title:28px;--font-size-title:36px;}[data-theme='dark']{--color-main:#2c93ea;--color-text:#eff3f6;--color-text-footer:#c6d3dc;--color-text-quote:#a6bac9;--color-bg:#1a1e21;--color-blur:#202d3a75;--color-bg-footer:#202d3a;--color-border:#2d3a47;}@media only screen and (max-width: 767px){html{font-size:14px;}:root{--page-width:100%;--header-height:45px;--footer-height:72px;--font-size-xs:10px;--font-size-sm:12px;--font-size-md:14px;--font-size-lg:16px;--font-size-h4:16px;--font-size-h3:18px;--font-size-h2:20px;--font-size-h1:24px;--font-size-sub-title:21px;--font-size-title:24.5px;}}code[class*='language-'],pre[class*='language-']{color:#657b83;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}pre[class*='language-']::selection,pre[class*='language-'] ::selection,code[class*='language-']::selection,code[class*='language-'] ::selection{background:#073642;}pre[class*='language-']{padding:1.5em 1em;overflow:auto;border-radius:0.3em;position:relative;}:not(pre)>code[class*='language-'],pre[class*='language-']{background-color:#fdf6e3;}.gatsby-highlight pre[class*='language-']::after{background-color:var(--color-main);border-radius:0px 0px 4px 4px;color:var(--color-bg);font-size:0.75rem;font-family:SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;letter-spacing:0.075em;line-height:1;padding:0.25rem 0.5rem;position:absolute;left:1.5rem;text-align:right;top:0;}.gatsby-highlight pre.language-javascript::after{content:"JavaScript";}.gatsby-highlight pre.language-typescript::after{content:"TypeScript";}.gatsby-highlight pre.language-jsx::after{content:"JSX";}.gatsby-highlight pre.language-tsx::after{content:"TSX";}.gatsby-highlight pre.language-shell::after{content:"Shell";background-color:var(--color-text-quote);}.gatsby-highlight pre.language-text::after{content:"Text";background-color:var(--color-text-quote);}.gatsby-highlight pre.language-css::after{content:"CSS";background-color:var(--color-text-quote);}.gatsby-highlight pre.language-html::after{content:"HTML";background-color:var(--color-text-quote);}.gatsby-highlight pre.language-markdown::after{content:"Markdown";background-color:var(--color-text-quote);}.gatsby-highlight pre.language-java::after{content:"Java";}:not(pre)>code[class*='language-']{padding:0.1em;border-radius:0.3em;}.token.comment,.token.prolog,.token.doctype,.token.cdata{color:#93a1a1;}.token.punctuation{color:#586e75;}.token.namespace{opacity:0.7;}.token.property,.token.tag,.token.boolean,.token.number,.token.constant,.token.symbol,.token.deleted{color:#268bd2;}.token.selector,.token.attr-name,.token.string,.token.char,.token.builtin,.token.url,.token.inserted{color:#2aa198;}.token.entity{color:#657b83;background:#eee8d5;}.token.atrule,.token.attr-value,.token.keyword{color:#859900;}.token.function,.token.class-name{color:#b58900;}.token.regex,.token.important,.token.variable{color:#cb4b16;}.token.important,.token.bold{font-weight:bold;}.token.italic{font-style:italic;}.token.entity{cursor:help;}pre[class*='language-'].line-numbers{position:relative;padding-left:3.5em;counter-reset:linenumber;}pre[class*='language-'].line-numbers>code{position:relative;white-space:inherit;}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;padding:1.5em 0 1.5em 1em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}.line-numbers-rows>span{display:block;counter-increment:linenumber;}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:0.8em;text-align:right;}html{background-color:var(--color-bg-footer);}body{color:var(--color-text);background-color:var(--color-bg);font-weight:var(--font-weight-light);font-family:'Noto Sans KR',sans-serif;-webkit-font-smoothing:auto;-moz-osx-font-smoothing:auto;transform-style:preserve-3d;}pre[class*='language-']{background-color:var(--color-bg-footer);border:1px solid var(--color-border);}.caption{width:100%;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:-1rem;-webkit-transform:translateY(-1rem);-moz-transform:translateY(-1rem);-ms-transform:translateY(-1rem);transform:translateY(-1rem);}</style><style data-emotion="css q8kb3d">.css-q8kb3d{height:var(--header-height);border-bottom:1px solid var(--color-border);}</style><header class="css-q8kb3d e1u3ibb76"><style data-emotion="css 87me26">.css-87me26{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;max-width:var(--page-width);height:100%;margin:0 auto;padding:0 16px;}</style><div class="css-87me26 e1u3ibb75"><style data-emotion="css ek3v2y">@media only screen and (max-width: 767px){.css-ek3v2y{-webkit-transform:scale(80%);-moz-transform:scale(80%);-ms-transform:scale(80%);transform:scale(80%);}}</style><div class="css-ek3v2y e1jn8yjs1"><a href="/posts/"><style data-emotion="css z2dzj4">.css-z2dzj4{display:block;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;height:-webkit-fit-content;height:-moz-fit-content;height:fit-content;-webkit-transition:-webkit-transform 0.1s;transition:transform 0.1s;}.css-z2dzj4:hover{-webkit-transform:scale(105%);-moz-transform:scale(105%);-ms-transform:scale(105%);transform:scale(105%);}.css-z2dzj4:active{-webkit-transform:scale(110%);-moz-transform:scale(110%);-ms-transform:scale(110%);transform:scale(110%);}</style><span class="css-z2dzj4 e1jn8yjs0"><style data-emotion="css 1eldebu">.css-1eldebu{font-weight:var(--font-weight-regular);margin-top:0.5em;font-size:var(--font-size-h4);}</style><h4 class="css-1eldebu e3wkkfe10">hanse-kim.dev</h4></span></a></div><style data-emotion="css 1yupmj4">.css-1yupmj4{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-column-gap:8px;column-gap:8px;}</style><nav class="css-1yupmj4 e1u3ibb74"><style data-emotion="css g3wgm0">.css-g3wgm0{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:4px;border:none;border-radius:9999px;background-color:transparent;cursor:pointer;-webkit-transition:background-color 0.2s;transition:background-color 0.2s;}.css-g3wgm0>.e12387pw1{color:var(--color-text-footer);}.css-g3wgm0:hover{-webkit-transform:scale(105%);-moz-transform:scale(105%);-ms-transform:scale(105%);transform:scale(105%);}.css-g3wgm0:active{-webkit-transform:scale(110%);-moz-transform:scale(110%);-ms-transform:scale(110%);transform:scale(110%);background-color:var(--color-bg-footer);}</style><button class="css-g3wgm0 e12387pw0"><style data-emotion="css 11z6fks">.css-11z6fks{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;height:-webkit-fit-content;height:-moz-fit-content;height:fit-content;color:var(--color-main);}</style><span class="material-symbols-rounded css-11z6fks e12387pw1">light_mode</span></button></nav></div></header><style data-emotion="css 1ff36h2">.css-1ff36h2{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><main class="css-1ff36h2 e1u3ibb73"><style data-emotion="css 88csqt">.css-88csqt{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;row-gap:36px;position:relative;max-width:var(--page-width);height:100%;margin:0 auto;padding:48px 16px 96px;}@media only screen and (max-width: 767px){.css-88csqt{padding:16px 16px 36px 16px;row-gap:24px;}}</style><div class="css-88csqt e1u3ibb72"><style data-emotion="css 1ywe81w animation-1vzvs4z">.css-1ywe81w{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;row-gap:36px;-webkit-animation:animation-1vzvs4z 0.5s ease;animation:animation-1vzvs4z 0.5s ease;}@-webkit-keyframes animation-1vzvs4z{from{opacity:0;-webkit-transform:translateY(10px);-moz-transform:translateY(10px);-ms-transform:translateY(10px);transform:translateY(10px);}to{opacity:1;-webkit-transform:translateY(0);-moz-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);}}@keyframes animation-1vzvs4z{from{opacity:0;-webkit-transform:translateY(10px);-moz-transform:translateY(10px);-ms-transform:translateY(10px);transform:translateY(10px);}to{opacity:1;-webkit-transform:translateY(0);-moz-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);}}</style><article class="css-1ywe81w ex0erni2"><style data-emotion="css muc85u">.css-muc85u{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;row-gap:16px;}</style><header class="css-muc85u ex0erni1"><a href="/posts/"><style data-emotion="css 11w4qq1">.css-11w4qq1{width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;padding-top:2px;background:none;border:none;-webkit-transition:text-shadow 0.2s;transition:text-shadow 0.2s;cursor:pointer;}.css-11w4qq1:disabled{cursor:default;}.css-11w4qq1:hover:not(:disabled){text-shadow:0 0 0.5px var(--color-text);}</style><button class="css-11w4qq1 ec99sh01">&lt; 이전 페이지로<style data-emotion="css 1wmy4ci">.css-1wmy4ci{margin:1px auto 0 auto;width:0;height:1px;background-color:var(--color-text);-webkit-transition:width 0.2s;transition:width 0.2s;}.ec99sh01:hover:not(:disabled)>.css-1wmy4ci{width:100%;}</style><div class="css-1wmy4ci ec99sh00"></div></button></a><hgroup><style data-emotion="css 4qfs0">.css-4qfs0{font-weight:var(--font-weight-light);font-size:var(--font-size-title);}</style><h1 class="css-4qfs0 eqxhvk72">CSR에서 동적 OG 적용하기</h1><style data-emotion="css harc7a">.css-harc7a{font-weight:var(--font-weight-thin);font-size:var(--font-size-md);}</style><p class="css-harc7a eqxhvk70">작성일: 2024-07-23</p></hgroup><span class="css-1yupmj4 e1379zna0"><a href="/tags/aws/"><style data-emotion="css 1c78yoi">.css-1c78yoi{padding:3px 8px 4px 8px;border:none;border-radius:4px;background-color:var(--color-border);color:var(--color-main);font-size:var(--font-size-xs);font-weight:var(--font-weight-regular);cursor:pointer;-webkit-transition:color 0.2s,background-color 0.2s;transition:color 0.2s,background-color 0.2s;}.css-1c78yoi:hover{color:var(--color-bg);background-color:var(--color-main);}</style><span class="css-1c78yoi e1379zna1">AWS</span></a><a href="/tags/troubleshooting/"><span class="css-1c78yoi e1379zna1">Troubleshooting</span></a></span></header><style data-emotion="css 2in4ak">.css-2in4ak{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;row-gap:var(--font-size-md);}</style><div class="css-2in4ak ex0erni0"><div><p>최근 회사에서 가볍고 빠른 성능의 사이트가 필요하다는 요구가 있어 Vite와 Svelte로 SPA를 개발하게 되었습니다. 동적 라우팅이 필요했고, 경로에 따라 백오피스에서 설정한 커스텀 페이지를 보여주는 사이트였습니다.</p></div>
<div><p>문제는 동적 경로에 따라 OG 메타태그를 적용해야 한다는 사실이었습니다. 취업 준비를 하던 시절 &quot;CSR = SEO가 불가능&quot;이라고 거의 공식처럼 암기했기 때문에, 저는 당연히 불가능한 일이라고 생각했습니다.</p></div>
<p>하지만 뜻밖에도 <style data-emotion="css ejk9d8">.css-ejk9d8{display:inline-block;-webkit-text-decoration:underline;text-decoration:underline;-webkit-transition:-webkit-transform 0.1s;transition:transform 0.1s;}.css-ejk9d8:link{color:var(--color-main);}.css-ejk9d8:visited{color:mediumpurple;}.css-ejk9d8::after{content:'🔗';font-size:0.9em;}</style><a href="https://techblog.woowahan.com/15469/" class="css-ejk9d8 e3wkkfe4">이 문제를 해결한 포스팅</a>을 알게 되었고, 이를 참고해 무사히 해결할 수 있었습니다. (감사합니다!) 비슷한 고민이 있는 분들은 해당 포스팅이 큰 도움이 되리라 생각합니다.</p>
<div><p>전반적인 해결 방법은 위 포스팅을 통해서도 충분히 얻을 수 있었지만, 그럼에도 겪은 문제들과 이를 통해 알게 된 내용들을 정리했습니다.</p></div>
<style data-emotion="css fdtbo8">.css-fdtbo8{width:100%;border-bottom:1px solid var(--color-border);}</style><hgroup class="css-fdtbo8 e3wkkfe14"><style data-emotion="css dn7acr">.css-dn7acr{font-weight:var(--font-weight-regular);margin-top:0.5em;font-size:var(--font-size-h2);}</style><h2 class="css-dn7acr e3wkkfe12">CSR에서 동적 OG 메타태그를 적용하는 방법</h2></hgroup>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 545px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/662b513ecb452b1df4d7a26cca47235c/d2d42/cloudfront-events-that-trigger-lambda-functions.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 35.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABgUlEQVR42jVRXUvCYBTeP+q2/9JddBV1EXQRBUU33YZBQVD0QSwvsgL70FkmqWk5E9y71Olw06kscWmuze396tXo4eHAOc95OIdzOEIInYBADw77GFOMxrW/eg+8p5bmusnHse46TCV4LJAJONaBEMSUDk21HD/+qAFJzmUKD+63Sc1S++4kszDTCh11QbT4HFK0ysubUNWLdOLnHMdxXYcl9ZYcFU9jr0dC9jBwPlsReWoUfDVjCbwPHjMv+5HswZN4dna/zkc2JKkoinlOURQAAIu2PSQ/PYIg28q3e0TLmQWB0SoneyCBamlkNdgMH45YDAaDO4EAV5SkSrnct92vUlzenNL5ReNypcnP9xN7/VK6WxAYLTlpnM59bE0b16vGxfJneC31cBMRYtz3YNDptD1EfKujh7frCmhU5XpFslWRalmi54j+xva381fa7W5TU3VFamkKszQNg6P/wAiikQMRgQj7CGPoY7MKtRwj6qrEc9i1Rx50R57r+X+/+AWxlWmomzV4EQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/662b513ecb452b1df4d7a26cca47235c/89b46/cloudfront-events-that-trigger-lambda-functions.webp 180w,
/static/662b513ecb452b1df4d7a26cca47235c/97ead/cloudfront-events-that-trigger-lambda-functions.webp 360w,
/static/662b513ecb452b1df4d7a26cca47235c/21895/cloudfront-events-that-trigger-lambda-functions.webp 545w"
              sizes="(max-width: 545px) 100vw, 545px"
              type="image/webp"
            />
          <source
            srcset="/static/662b513ecb452b1df4d7a26cca47235c/96042/cloudfront-events-that-trigger-lambda-functions.png 180w,
/static/662b513ecb452b1df4d7a26cca47235c/7a322/cloudfront-events-that-trigger-lambda-functions.png 360w,
/static/662b513ecb452b1df4d7a26cca47235c/d2d42/cloudfront-events-that-trigger-lambda-functions.png 545w"
            sizes="(max-width: 545px) 100vw, 545px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/662b513ecb452b1df4d7a26cca47235c/d2d42/cloudfront-events-that-trigger-lambda-functions.png"
            alt="cloudfront-events-that-trigger-lambda-functions.png"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></span>
<span style="text-align:center;margin:0 auto;font-style:italic;color:var(--color-text-footer)">출처: <a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-cloudfront-trigger-events.html" class="css-ejk9d8 e3wkkfe4">AWS 공식문서</a></span>
<div><p>AWS CloudFront에서는 위와 같은 네 구간에 엣지 함수를 설정할 수 있습니다.</p></div>
<p>방법을 요약하면 Viewer request 이벤트에 엣지 함수를 설정해서, 요청자가 봇인지 아닌지를 판별해 봇일 경우 <style data-emotion="css 13ixm15">.css-13ixm15{font-weight:var(--font-weight-medium);}</style><strong class="css-13ixm15 e3wkkfe5">OG 메타태그만을 포함한 HTML</strong>을 생성하여 응답으로 보내는 것입니다.</p>
<div><p>즉 봇에 의한 요청일 경우 Viewer request 단계에서 바로 응답을 생성하여 OG 메타태그 HTML을 응답으로 보내고, 그 이외에 실사용자에 의한 요청일 경우 정상적으로 CloudFront 원본(제 경우에는 S3)을 거쳐 응답을 보냅니다.</p></div>
<div><p>주의할 점은 만약 클라이언트 사이드 라우팅 방식이 hash property 기반일 경우에는 위 방식이 불가능하다는 것입니다. hash property는 서버로 전달되지 않기 때문에, 어떤 페이지를 요청하든 CloudFront 측에서는 동일한 페이지로 간주합니다. 이로 인해 페이지별로 적절한 OG 태그를 생성하는 것이 어렵습니다.</p></div>
<div><p>저 역시 위와 같은 이슈로 인해 라우팅 라이브러리를 변경해야 했습니다.</p></div>
<hgroup class="css-fdtbo8 e3wkkfe14"><h2 class="css-dn7acr e3wkkfe12"><strong class="css-13ixm15 e3wkkfe5">CloudFront Functions</strong> vs <strong class="css-13ixm15 e3wkkfe5">Lambda@Edge</strong></h2></hgroup>
<p>둘의 차이는 위 포스팅에 잘 요약되어 있고, <a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/edge-functions-choosing.html" class="css-ejk9d8 e3wkkfe4">공식 문서</a>에서 좀더 상세한 내용을 확인할 수 있습니다.</p>
<div><p>제가 고려한 차이점은 다음과 같습니다.</p></div>
<style data-emotion="css 4vl8vq">.css-4vl8vq{border-collapse:collapse;border-radius:2px;overflow:hidden;}.css-4vl8vq th,.css-4vl8vq td{padding:4px 8px;border:1px solid var(--color-border);}.css-4vl8vq th{background-color:var(--color-bg-footer);}.css-4vl8vq tr:nth-child(even){background-color:var(--color-blur);}</style><table class="css-4vl8vq e3wkkfe0"><thead><tr><th align="center"></th><th>CloudFront Functions</th><th>Lambda@Edge</th></tr></thead><tbody><tr><td align="center">특징</td><td>간단한 작업에 적합</td><td>복잡한 작업 가능</td></tr><tr><td align="center">적용 가능한 이벤트</td><td>Viewer request/response</td><td>Viewer request/response,<br/>Origin request/response</td></tr><tr><td align="center">네트워크 통신</td><td>X</td><td>O</td></tr><tr><td align="center">외부 라이브러리 사용</td><td>X</td><td>O</td></tr><tr><td align="center">비용</td><td>요청당 비용 청구</td><td>요청 및 함수 지속 시간당<br/>비용 청구</td></tr></tbody></table>
<div><p>제 경우에는 OG 태그 생성을 위해 API 콜이 필수적이었으므로 Lambda@Edge 외엔 선택지가 없었습니다.</p></div>
<hgroup class="css-fdtbo8 e3wkkfe14"><h2 class="css-dn7acr e3wkkfe12"><del>람다 계층 사용</del></h2></hgroup>
<p>처음에는 Fetch API를 사용해 API 콜을 하려 했지만, <style data-emotion="css kul9rz">.css-kul9rz{width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;padding:0 0.25em;margin:0 2px;border:1px solid var(--color-border);border-radius:4px;background-color:var(--color-bg-footer);color:var(--color-main);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;}</style><code class="css-kul9rz e3wkkfe2">fetch</code> 함수가 존재하지 않는다는 에러를 만났습니다. 람다 함수는 노드 환경이고 Fetch API는 웹 브라우저가 제공하는 API이기 때문입니다.</p>
<div><p>저는 그 대안으로서 Aixos를 사용하고자 했습니다. Axios의 기반이 되는 XHR 역시 브라우저 API지만, Axios는 서버 사이드에서도 동작하는 라이브러리인 만큼 노드 환경에 필요한 dependency가 갖춰져 있을 거라 생각했습니다.</p></div>
<div><p>람다 함수에서 외부 라이브러리를 사용하는 방법은 크게 두 가지였습니다.</p></div>
<style data-emotion="css 1magvvh">.css-1magvvh{padding-left:2rem;list-style:revert;}div>div>.css-1magvvh{margin-top:var(--font-size-sm);}</style><ul class="css-1magvvh e3wkkfe9">
<style data-emotion="css 1o5bol2">.css-1o5bol2:not(:first-of-type){margin-top:var(--font-size-sm);}</style><li class="css-1o5bol2 e3wkkfe7"><style data-emotion="css 139iib9">.css-139iib9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;row-gap:var(--font-size-sm);}</style><div class="css-139iib9 e3wkkfe6"><div>
<div><p>외부 라이브러리를 포함하는 .zip 파일을 생성해 업로드한다.</p></div>
</div></div></li>
<li class="css-1o5bol2 e3wkkfe7"><div class="css-139iib9 e3wkkfe6"><div>
<p><strong class="css-13ixm15 e3wkkfe5">람다 계층(Lambda layer)</strong> 을 추가한다.</p>
</div></div></li>
</ul>
<div><p>람다 계층이란 람다 함수와 별도로 외부 종속성을 관리하기 위한 기능입니다. 즉 저 두 가지 방식은 라이브러리 코드를 하나의 람다 함수 패키지에 전부 집어넣느냐, 아니면 따로 분리해서 관리하느냐 차이입니다.</p></div>
<div><p>람다 계층을 사용하면 하나의 종속성을 여러 람다 함수에서 재사용 가능하기 때문에, 종속성을 추가할 때 일반적으로 권장하는 방법이었습니다. 따라서 저도 이 방법을 택했습니다.</p></div>
<div><p>계층을 구성하는 방법은 간단한데, 우선 아래와 같은 형태로 구성되도록 .zip 파일을 만든 후 AWS 콘솔에서 람다   계층을 추가할 때 업로드하면 됩니다.</p></div>
<span><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">axios-layer.zip
└ nodejs
  └ axios
    └ ...</code></pre></div></span>
<div><p>람다 함수의 런타임 버전이 계층의 호환 런타임 버전에 포함되어야 한다는 점만 주의하면 계층 생성에서 크게 어려운 점은 없었습니다.</p></div>
<p>저는 Axios 종속성을 위한 계층을 생성하고 이를 람다 함수에 추가했습니다. 그리고 <strong class="css-13ixm15 e3wkkfe5">Lambda@Edge에는 계층 사용이 불가능하다</strong>는 사실을 뒤늦게 알게 되었습니다. (<a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-at-edge-function-restrictions.html#lambda-at-edge-restrictions-features" class="css-ejk9d8 e3wkkfe4"></a>)</p>
<hgroup class="css-fdtbo8 e3wkkfe14"><h2 class="css-dn7acr e3wkkfe12">네트워크 통신, 그리고 해결</h2></hgroup>
<p><a href="https://nodejs.org/api/https.html" class="css-ejk9d8 e3wkkfe4">노드의 HTTPS 모듈</a>을 사용해 API 콜을 할 수 있었습니다. Lambda@Edge 문서의 함수 예제에는 없는 내용이라 구글링을 하던 중 한 AWS 포스팅에서 해당 내용을 찾게 되었습니다. (<a href="https://aws.amazon.com/ko/blogs/networking-and-content-delivery/leveraging-external-data-in-lambdaedge/" class="css-ejk9d8 e3wkkfe4"></a>)</p>
<div><p>HTTPS 모듈은 사용 방법이 조금 복잡해서, 아래와 같이 한번 래핑해서 사용했습니다.</p></div>
<span><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">fetchData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    https
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> rawData <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

        res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          rawData <span class="token operator">+=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> parsedData <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rawData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>parsedData<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<div><p>또한 함수가 잘 동작하는지 확인하기 위해 주기적으로 테스트를 해가며 함수를 작성할 필요가 있었는데, 저는 다음과 같은 과정을 거쳐 테스트 데이터를 구했습니다.</p></div>
<style data-emotion="css zd747l">.css-zd747l{padding-left:2rem;list-style:auto;}div>div>.css-zd747l{margin-top:var(--font-size-sm);}</style><ol class="css-zd747l e3wkkfe8">
<li class="css-1o5bol2 e3wkkfe7"><div class="css-139iib9 e3wkkfe6"><div>
<p><a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-event-structure.html" class="css-ejk9d8 e3wkkfe4">Lambda@Edge 이벤트 구조</a> 문서에서 일반적인 Viewer request 이벤트를 구해 테스트하고, 기본적인 함수를 구성합니다.</p>
</div></div></li>
<li class="css-1o5bol2 e3wkkfe7"><div class="css-139iib9 e3wkkfe6"><div>
<p><a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-examples.html#lambda-examples-generated-response-examples" class="css-ejk9d8 e3wkkfe4">함수 예제</a>를 참고하여 Viewer request에서 바로 응답을 생성하는 함수를 작성합니다. 이때, response body는 <code class="css-kul9rz e3wkkfe2">handler</code> 함수의 <code class="css-kul9rz e3wkkfe2">event</code> 파라미터를 <code class="css-kul9rz e3wkkfe2">JSON.stringify()</code>로 처리한 값을 넣습니다.</p>
</div></div></li>
<li class="css-1o5bol2 e3wkkfe7"><div class="css-139iib9 e3wkkfe6"><div>
<div><p>웹사이트의 CloudFront에 람다 함수를 연결합니다. 웹사이트에 접속하면 실제 Viewer request 이벤트를 본문으로 얻을 수 있습니다.</p></div>
</div></div></li>
</ol>
<div><p>위와 같은 과정을 거쳐 테스트 데이터를 얻고, 무사히 원하는 기능을 구현할 수 있었습니다.</p></div>
<hgroup class="css-fdtbo8 e3wkkfe14"><h2 class="css-dn7acr e3wkkfe12">마치며</h2></hgroup>
<div><p>처음에는 당연히 불가능하다고 생각한 일이었고 실제로 프론트엔드 코드 상에서 해결하기는 힘든 이슈였습니다. 그러나 인프라를 통해 해결할 수 있었고, 이러한 경험을 얻은 것을 행운이라 생각합니다.</p></div>
<div><p>문제를 해결하기 위한 시야가 한층 더 넓어진 한편, 좁은 상식을 근거로 불가능하다고 단정지었던 제 자신을 반성할 수 있는 기회였습니다.</p></div>
<div><p>마지막으로 이 문제를 해결하는 데 도움을 준 모든 자료와 포스팅에 감사드리며, 이 글이 비슷한 고민을 하는 분들께 유용한 참고자료가 되기를 바랍니다.</p></div></div></article></div></main><style data-emotion="css 1m0nbu8">.css-1m0nbu8{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-column-gap:0.25rem;column-gap:0.25rem;height:var(--footer-height);background-color:var(--color-bg-footer);color:var(--color-text-footer);font-size:var(--font-size-sm);font-weight:var(--font-weight-thin);}</style><footer class="css-1m0nbu8 e1u3ibb71">Copyright <!-- -->2022-2024<!-- -->.<style data-emotion="css rzk2xp">.css-rzk2xp{-webkit-text-decoration:underline;text-decoration:underline;font-weight:var(--font-weight-regular);}</style><a href="https://github.com/hanse-kim" class="css-rzk2xp e1u3ibb70">hanse-kim</a>All right reserved.</footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/2024/07-23-csr-open-graph/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-cf443b7d6a054549ca07.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-ec3e7ba7dcb61cce7ff2.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-dbd08cd73a3c9dc5cccb.js\"],\"component---src-pages-posts-tsx\":[\"/component---src-pages-posts-tsx-96ecffa9fd365d81a997.js\"],\"component---src-pages-tags-tsx\":[\"/component---src-pages-tags-tsx-98a4e1db67aeb3494dc1.js\"],\"component---src-templates-{post}-tsx-content-file-path-posts-2024-02-18-remark-gfm-index-mdx\":[\"/component---src-templates-{post}-tsx-content-file-path-posts-2024-02-18-remark-gfm-index-mdx-2b7a35b793d8bea618db.js\"],\"component---src-templates-{post}-tsx-content-file-path-posts-2024-07-19-spa-404-index-mdx\":[\"/component---src-templates-{post}-tsx-content-file-path-posts-2024-07-19-spa-404-index-mdx-b00f3b72e7b92eb21e43.js\"],\"component---src-templates-{post}-tsx-content-file-path-posts-2024-07-23-csr-open-graph-index-mdx\":[\"/component---src-templates-{post}-tsx-content-file-path-posts-2024-07-23-csr-open-graph-index-mdx-b3825e4686e130e0f21c.js\"],\"component---src-templates-{tag}-tsx\":[\"/component---src-templates-{tag}-tsx-26ffa8735896b445057e.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="96f7d6d3b9ff73eac5c0";</script><script src="/webpack-runtime-91e883f4d0821e96920a.js" async></script><script src="/framework-50205c55367d3c69aee3.js" async></script><script src="/app-cf443b7d6a054549ca07.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>